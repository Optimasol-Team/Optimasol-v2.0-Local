#!/usr/bin/env bash
# Lightweight admin wrapper for Optimasol Docker deployment.
set -euo pipefail

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COMPOSE_FILE="${COMPOSE_FILE:-${BASE_DIR}/docker-compose.yml}"
SERVICE_NAME="optimasol"

_require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Erreur: \"$1\" n'est pas installé ou pas dans le PATH." >&2
    exit 1
  fi
}

_compose() {
  docker compose -f "$COMPOSE_FILE" "$@"
}

_ensure_volumes() {
  docker volume create optimasol-data >/dev/null
  docker volume create optimasol-backups >/dev/null
  docker volume create mosquitto-data >/dev/null
}

usage() {
  cat <<'EOF'
Usage: optimasol <commande> [options]

Commandes courantes :
  install          Crée les volumes, construit l'image, lance le service
  start            Démarre (ou crée) le conteneur en arrière-plan
  stop             Arrête le conteneur
  restart          Redémarre le conteneur
  status           Affiche l'état du conteneur
  logs [-f]        Affiche les logs (option -f pour suivre)
  cli [args]       Exécute la CLI Optimasol dans le conteneur
  api [args]       Lance l'API FastAPI (process éphémère)
  update           git pull (si repo) + rebuild image + restart
  build            Construit l'image locale
  help             Affiche cette aide
EOF
}

cmd=${1:-help}
shift || true

case "$cmd" in
  install)
    _require docker
    _compose version >/dev/null
    _ensure_volumes
    _compose pull "$SERVICE_NAME" || true
    _compose build "$SERVICE_NAME"
    _compose up -d "$SERVICE_NAME"
    ;;
  start)
    _require docker
    _compose up -d "$SERVICE_NAME"
    ;;
  stop)
    _require docker
    _compose stop "$SERVICE_NAME"
    ;;
  restart)
    _require docker
    _compose restart "$SERVICE_NAME"
    ;;
  status)
    _require docker
    _compose ps "$SERVICE_NAME"
    ;;
  logs)
    _require docker
    _compose logs "$@"
    ;;
  cli)
    _require docker
    _compose run --rm "$SERVICE_NAME" cli "$@"
    ;;
  api)
    _require docker
    _compose run --rm -p 8000:8000 "$SERVICE_NAME" api "$@"
    ;;
  update)
    _require docker
    if [ -d "${BASE_DIR}/.git" ]; then
      git -C "$BASE_DIR" pull --rebase --autostash || true
    fi
    _compose build --pull "$SERVICE_NAME"
    _compose up -d "$SERVICE_NAME"
    ;;
  build)
    _require docker
    _compose build "$SERVICE_NAME"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    usage
    exit 1
    ;;
esac
