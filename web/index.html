<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimasol · Console</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="grid-overlay">
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div style="width:32px;height:32px;border-radius:12px;background:linear-gradient(135deg,#5efc8d,#f97316);display:grid;place-items:center;font-weight:800;color:#041026;">OS</div>
        <div>
          <div class="title">Optimasol Control</div>
          <div class="muted">Pilotage PV Router · météo + optimisation</div>
        </div>
      </div>
      <div class="pill" id="servicePill"><span class="status-dot"></span><span id="serviceText">Service inconnu</span></div>
      <div class="pill" id="dbPill">DB: --</div>
      <div class="pill" id="userPill">Hors session</div>
    </div>

    <section id="authArea" class="card">
      <h3>Connexion ou activation</h3>
      <p class="muted">Connectez-vous avec votre email + mot de passe ou activez votre compte à l’aide de la clé fournie par l’admin CLI.</p>
      <div class="auth-grid">
        <div class="card" style="background:rgba(255,255,255,0.04);">
          <h3>Connexion</h3>
          <form id="loginForm">
            <label>Email
              <input type="email" name="email" placeholder="client@site.fr" required>
            </label>
            <label>Mot de passe
              <input type="password" name="password" placeholder="••••••••" required>
            </label>
            <button class="btn" type="submit">Se connecter</button>
            <div class="error" id="loginError"></div>
          </form>
        </div>
        <div class="card" style="background:rgba(255,255,255,0.04);">
          <h3>Créer mon accès (clé d’activation)</h3>
          <div class="muted" style="margin-bottom:8px;">Les valeurs techniques sont pré-remplies; ajustez si besoin.</div>
          <form id="registerForm">
            <div class="grid cols-2">
              <label>Clé d’activation
                <input name="activation_key" placeholder="OPT-ABCD" required>
              </label>
              <label>Nom du site / client
                <input name="name" placeholder="Maison solaire" required>
              </label>
              <label>Email
                <input type="email" name="email" placeholder="client@site.fr" required>
              </label>
              <label>Mot de passe
                <input type="password" name="password" placeholder="••••••••" required>
              </label>
              <label>N° de série routeur
                <input name="serial" placeholder="PVROUTER001" required>
              </label>
              <label>Latitude / Longitude
                <input name="lat" placeholder="50.629" value="50.62925">
                <input name="lon" placeholder="3.057" value="3.057256">
              </label>
              <label>Altitude (m)
                <input name="alt" placeholder="25" value="25">
              </label>
              <label>PV : azimuth / inclinaison
                <input name="azimuth" placeholder="180">
                <input name="tilt" placeholder="25">
              </label>
              <label>PV : surface (m²)
                <input name="surface" placeholder="2.0">
              </label>
              <label>PV : puissance crête (Wc)
                <input name="power" placeholder="800">
              </label>
              <label>PV : rendement global (optionnel)
                <input name="pv_eff" placeholder="0.80">
              </label>
              <label>Ballon : volume (L)
                <input name="wh_volume" placeholder="200">
              </label>
              <label>Ballon : puissance (W)
                <input name="wh_power" placeholder="2400">
              </label>
              <label>Isolation (coeff)
                <input name="wh_insulation" placeholder="2.4">
              </label>
              <label>Eau froide (°C)
                <input name="wh_cold" placeholder="15">
              </label>
              <label>Température minimale (°C)
                <input name="min_temp" placeholder="45">
              </label>
              <label>Planning (jour heure °C volume)
                <textarea name="planning" placeholder="mon 07:00 52 40&#10;sun 20:00 50 25"></textarea>
              </label>
            </div>
            <div class="grid cols-2">
              <label>Mode tarif
                <select name="price_mode">
                  <option value="BASE">BASE</option>
                  <option value="HPHC">HPHC</option>
                </select>
              </label>
              <label>Prix BASE (€/kWh)
                <input name="price_base" placeholder="0.18">
              </label>
              <label>Prix HP (€/kWh)
                <input name="price_hp" placeholder="0.22">
              </label>
              <label>Prix HC (€/kWh)
                <input name="price_hc" placeholder="0.16">
              </label>
              <label>Prix revente (€/kWh)
                <input name="price_resell" placeholder="0.10">
              </label>
              <label>Créneaux HP (HH:MM-HH:MM)
                <textarea name="hp_slots" placeholder="06:00-08:00&#10;18:00-20:00"></textarea>
              </label>
              <label>Mode d’optimisation
                <select name="optim_mode">
                  <option value="cost">Réduction facture</option>
                  <option value="AutoCons">Autoconsommation</option>
                </select>
              </label>
              <label style="display:flex;align-items:center;gap:10px;margin-top:22px;">
                <input type="checkbox" name="gradation" checked style="width:18px;height:18px;">
                Activer la gradation
              </label>
            </div>
            <div class="flex wrap" style="align-items:center;">
              <button class="btn" type="submit">Activer et créer</button>
              <div class="error" id="registerError"></div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <section id="appArea" class="hidden">
      <div class="tabs">
        <button class="tab active" data-panel="overview">Vue d’ensemble</button>
        <button class="tab" data-panel="config">Paramètres</button>
        <button class="tab" data-panel="history">Historique</button>
      </div>

      <section id="panel-overview" class="panel">
        <div class="grid cols-3">
          <div class="card">
            <h3>Session</h3>
            <div class="stat">
              <div>
                <div class="value" id="ovName">--</div>
                <small id="ovEmail">--</small>
              </div>
              <div class="badge">Driver <span id="ovDriver">--</span></div>
            </div>
            <div class="muted" id="ovLocation">Position inconnue</div>
          </div>
          <div class="card">
            <h3>Dernières mesures</h3>
            <div class="grid cols-3">
              <div class="stat">
                <div>
                  <div class="value" id="ovTemp">--</div>
                  <small class="muted">Température</small>
                </div>
              </div>
              <div class="stat">
                <div>
                  <div class="value" id="ovProd">--</div>
                  <small class="muted">Production W</small>
                </div>
              </div>
              <div class="stat">
                <div>
                  <div class="value" id="ovDecision">--</div>
                  <small class="muted">Décision</small>
                </div>
              </div>
            </div>
            <div class="muted" id="ovStamps">—</div>
          </div>
          <div class="card">
            <h3>PV & optimisation</h3>
            <div class="stat">
              <div>
                <div class="value" id="ovPV">--</div>
                <small class="muted">Config PV</small>
              </div>
            </div>
            <div class="muted" id="ovOpt">--</div>
          </div>
        </div>
      </section>

      <section id="panel-config" class="panel hidden">
        <div class="grid cols-2">
          <div class="card">
            <h3>Identité & accès</h3>
            <form id="configForm">
              <label>Nom du site
                <input name="name" placeholder="Maison solaire">
              </label>
              <label>Email
                <input name="email" type="email" placeholder="client@site.fr">
              </label>
              <label>Mot de passe (laisser vide pour ne pas changer)
                <input name="password" type="password" placeholder="••••••••">
              </label>
              <label>N° de série routeur
                <input name="serial" placeholder="PVROUTER001">
              </label>
            </form>
          </div>

          <div class="card">
            <h3>Position & PV</h3>
            <div class="grid cols-3">
              <label>Latitude<input form="configForm" name="lat"></label>
              <label>Longitude<input form="configForm" name="lon"></label>
              <label>Altitude (m)<input form="configForm" name="alt"></label>
            </div>
            <div class="grid cols-2">
              <label>Azimuth<input form="configForm" name="azimuth"></label>
              <label>Inclinaison<input form="configForm" name="tilt"></label>
              <label>Surface (m²)<input form="configForm" name="surface"></label>
              <label>Puissance (Wc)<input form="configForm" name="power"></label>
              <label>Rendement global<input form="configForm" name="pv_eff"></label>
            </div>
          </div>

          <div class="card">
            <h3>Ballon & contraintes</h3>
            <div class="grid cols-2">
              <label>Volume (L)<input form="configForm" name="wh_volume"></label>
              <label>Puissance (W)<input form="configForm" name="wh_power"></label>
              <label>Isolation<input form="configForm" name="wh_insulation"></label>
              <label>Eau froide (°C)<input form="configForm" name="wh_cold"></label>
              <label>Température minimale (°C)<input form="configForm" name="min_temp"></label>
            </div>
            <label>Planning (jour heure °C volume)
              <textarea form="configForm" name="planning"></textarea>
            </label>
          </div>

          <div class="card">
            <h3>Tarifs & mode</h3>
            <div class="grid cols-2">
              <label>Mode tarif
                <select form="configForm" name="price_mode">
                  <option value="BASE">BASE</option>
                  <option value="HPHC">HPHC</option>
                </select>
              </label>
              <label>Prix BASE<input form="configForm" name="price_base"></label>
              <label>Prix HP<input form="configForm" name="price_hp"></label>
              <label>Prix HC<input form="configForm" name="price_hc"></label>
              <label>Prix revente<input form="configForm" name="price_resell"></label>
              <label>Créneaux HP (HH:MM-HH:MM)
                <textarea form="configForm" name="hp_slots"></textarea>
              </label>
              <label>Mode d’optimisation
                <select form="configForm" name="optim_mode">
                  <option value="cost">Réduction facture</option>
                  <option value="AutoCons">Autoconsommation</option>
                </select>
              </label>
              <label style="display:flex;align-items:center;gap:10px;margin-top:22px;">
                <input type="checkbox" form="configForm" name="gradation" style="width:18px;height:18px;">
                Gradation active
              </label>
            </div>
          </div>
        </div>
        <div class="flex wrap" style="align-items:center;margin-top:16px;">
          <button class="btn" id="saveConfigBtn">Enregistrer</button>
          <div class="success" id="configMsg"></div>
        </div>
      </section>

      <section id="panel-history" class="panel hidden">
        <div class="card">
          <div class="flex wrap" style="align-items:center;gap:12px;margin-bottom:12px;">
            <label style="min-width:160px;">Métrique
              <select id="histMetric">
                <option value="temperature">Température</option>
                <option value="production">Production</option>
                <option value="forecast">Prévisions</option>
                <option value="decision">Décision</option>
              </select>
            </label>
            <label style="min-width:140px;">Période (h)
              <select id="histHours">
                <option value="24">24h</option>
                <option value="48">48h</option>
                <option value="168">7 jours</option>
              </select>
            </label>
            <button class="btn secondary" id="reloadHistory">Charger</button>
          </div>
          <div class="chart-wrap">
            <canvas id="historyChart"></canvas>
          </div>
          <table class="table" id="historyTable"></table>
        </div>
      </section>
    </section>
  </div>

  <script src="app.js"></script>
</body>
</html>
