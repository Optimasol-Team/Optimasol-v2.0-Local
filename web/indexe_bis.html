<!doctype html>
<!-- ä¸­ï¼šHTML5 æ–‡æ¡£å£°æ˜Žï¼Œå‘Šè¯‰æµè§ˆå™¨æŒ‰çŽ°ä»£æ ‡å‡†è§£æžã€‚
EN: HTML5 doctype; tells the browser to use standards mode.
FR: DÃ©claration HTML5 ; indique au navigateur dâ€™utiliser le mode standard. -->

<html lang="en">
<!--ä¸­ï¼šé¡µé¢è¯­è¨€è®¾ä¸ºè‹±æ–‡ï¼ˆå¯å½±å“è¯»å±ä¸Žæ‹¼å†™æ£€æŸ¥ï¼‰ã€‚
EN: Document language set to English (screen readers/spellcheck).
FR: Langue du document en anglais (lecteurs dâ€™Ã©cran/correction).-->


<head>
<!--ä¸­ï¼šå¤´éƒ¨å…ƒä¿¡æ¯ä¸Žæ ·å¼ã€‚
EN: Metadata and styles.
FR: MÃ©tadonnÃ©es et styles.-->
  <meta charset="utf-8"/>
  <!--ä¸­ï¼šUTF-8 ç¼–ç ï¼Œæ”¯æŒå¤šè¯­è¨€å­—ç¬¦ã€‚
  EN: UTF-8 encoding for multilingual text.
  FR: Encodage UTF-8 pour le texte multilingue.-->
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!--ä¸­ï¼šç§»åŠ¨ç«¯è‡ªé€‚åº”è§†å£ã€‚
  EN: Responsive viewport for mobile.
  FR: Viewport rÃ©actif pour mobile.-->
  <title>PV Router UI</title>
  <!--ä¸­ï¼šæµè§ˆå™¨æ ‡ç­¾æ ‡é¢˜ã€‚
  EN: Page title shown in browser tab.
  FR: Titre de lâ€™onglet du navigateur.-->
  <script src="https://cdn.tailwindcss.com"></script>
  <!--ä¸­ï¼šå¼•å…¥ TailwindCSS CDNï¼Œä¾¿æ·ä½¿ç”¨åŽŸå­ç±»æ ·å¼ã€‚
  EN: Load TailwindCSS via CDN for utility classes.
  FR: Charge TailwindCSS via CDN pour des classes utilitaires.-->
  <style>
    .navbtn{padding:.5rem 1rem;border-radius:.75rem}
    .card{border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  </style>
  <!--ä¸­ï¼šå®šä¹‰ä¸¤ä¸ªç®€å•çš„ CSS è¾…åŠ©ç±» .navbtnã€.cardã€‚
  EN: Two helper CSS classes for buttons/cards.
  FR: Deux classes CSS utilitaires pour boutons/cartes.-->
</head>


<body class="bg-gray-50 text-gray-900">
<!--ä¸­ï¼šå…¨å±€æµ…ç°èƒŒæ™¯ã€æ·±ç°æ–‡å­—ã€‚
EN: Global light-gray background, dark text.
FR: Fond gris clair, texte gris foncÃ© global.--> 
  <header class="bg-white shadow-sm sticky top-0 z-10">
  <!--ä¸­ï¼šå›ºå®šåœ¨é¡¶éƒ¨çš„ç™½è‰²å¯¼èˆªæ¡ï¼Œå«äº§å“åã€å¯¼èˆªé¡¹ã€çŠ¶æ€ä¸Žç™»å‡ºã€‚
  EN: Sticky white navbar with app name, nav items, status & logout.
  FR: Barre de navigation blanche fixe avec nom, onglets, statut & dÃ©connexion.-->
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="font-semibold">ðŸ”† PV Router</div>
      <nav class="flex gap-2 text-sm">
      <!--ä¸­ï¼šå…­ä¸ªé”šç‚¹é“¾æŽ¥ï¼Œåˆ‡æ¢ hash è·¯ç”±è‡³å„é¡µé¢ï¼ˆdashboard/history/â€¦ï¼‰
      EN: Six anchor links to hash routes for pages.
      FR: Six liens dâ€™ancrage vers les routes hash des pages.-->
        <a href="#/dashboard" class="navbtn hover:bg-gray-100">Dashboard</a>
        <a href="#/history" class="navbtn hover:bg-gray-100">History</a>
        <a href="#/boost" class="navbtn hover:bg-gray-100">Boost</a>
        <a href="#/settings" class="navbtn hover:bg-gray-100">Settings</a>
        <a href="#/mqtt" class="navbtn hover:bg-gray-100">MQTT</a>
        <a href="#/dev" class="navbtn hover:bg-gray-100">Dev</a>
          <a href="#/client" class="navbtn hover:bg-gray-100">Client</a>
      </nav>
      <div class="ml-auto flex items-center gap-3 text-sm">
        <span id="statusText" class="text-gray-500"></span>
        <!--ä¸­ï¼šæ˜¾ç¤ºå½“å‰é¡µé¢åï¼ˆç”±è„šæœ¬æ›´æ–°ï¼‰ã€‚
        EN: Shows current page name (updated by JS).
        FR: Affiche la page courante (mis Ã  jour par JS).-->
        <button id="logoutBtn" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Logout</button>
        <!--ä¸­ï¼šæ¸…é™¤ä¼šè¯å¹¶è·³è½¬ç™»å½•ã€‚
        EN: Clears session and goes to login.
        FR: Efface la session et retourne Ã  la connexion.-->     
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
  <!--ä¸­ï¼šä¸­å¿ƒå®½åº¦é™åˆ¶ï¼Œå†…è¾¹è·å¸ƒå±€å®¹å™¨ã€‚
  EN: Centered max width container.
  FR: Conteneur centrÃ© Ã  largeur max.-->
    <!-- Login -->
    <section id="page-login" class="hidden">
      <!--ä¸­ï¼šç™»å½•è¡¨å•ï¼ˆè·¯ç”±å™¨IDã€å¯†ç ã€è¯­è¨€ï¼‰ä¸Žâ€œSign inâ€æŒ‰é’®ï¼Œé»˜è®¤éšè—ã€‚
      EN: Login form (router ID, password, language), hidden by default.
      FR: Formulaire de connexion (ID routeur, mot de passe, langue), cachÃ© par dÃ©faut.-->
      <div class="max-w-md mx-auto bg-white p-6 card">
        <h2 class="text-lg font-semibold mb-4">Login</h2>
        <div class="space-y-3">
          <label class="block text-sm">Router ID
            <input id="fRouter" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="PVROUTER001 / DEVACCOUNT"/>
            <!--ä¸­ï¼šè·¯ç”±å™¨IDæˆ–å¼€å‘è´¦å·è¾“å…¥ã€‚
            EN: Router ID or developer account input.
            FR: Saisie ID du routeur ou compte dev.-->
          </label>
          <label class="block text-sm">Password
            <input id="fPass" type="password" class="mt-1 w-full border rounded-lg px-3 py-2"/>
            <!--ä¸­ï¼šå¯†ç è¾“å…¥ã€‚
            EN: Password input.
            FR: Saisie du mot de passe.-->
          </label>
          <label class="block text-sm">Language
            <select id="fLang" class="mt-1 w-full border rounded-lg px-3 py-2">
            <!--ä¸­ï¼šç•Œé¢è¯­è¨€é€‰æ‹©ï¼ˆen/fr/zhï¼‰ã€‚
            EN: UI language select.
            FR: SÃ©lecteur de langue UI.-->
              <option value="en">English</option>
              <option value="fr">FranÃ§ais</option>
              <option value="zh">ä¸­æ–‡</option>
            </select>
          </label>
          <button id="loginBtn" class="w-full py-2 rounded-lg bg-gray-900 text-white hover:opacity-90">Sign in</button>
          <!--ä¸­ï¼šè§¦å‘ç™»å½•è¯·æ±‚ã€‚
          EN: Triggers login request.
          FR: DÃ©clenche la connexion.-->
          <p id="loginErr" class="text-sm text-red-600"></p>
          <!--ä¸­ï¼šæ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯ã€‚
          EN: Shows login error.
          FR: Affiche lâ€™erreur de connexion.-->
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="page-dashboard" class="hidden space-y-4">
    <!--ä¸­ï¼šå››å¼ å¡ç‰‡æ˜¾ç¤º Grid/Solar/TEMP1/MODEINFOï¼›ä¸‹æ–¹â€œPredictionâ€å—æ˜¾ç¤ºé¢„æµ‹ä¸Žåˆ·æ–°æ—¶é—´ã€‚
    EN: Four stat cards + â€œPredictionâ€ with refresh time.
    FR: Quatre cartes + â€œPredictionâ€ avec heure de mise Ã  jour.-->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500">Grid (W)</div><div id="grid_w" class="text-3xl font-bold">--</div></div>
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500">Solar (W)</div><div id="solar_w" class="text-3xl font-bold">--</div></div>
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500">TEMP1 (Â°C)</div><div id="temp_c" class="text-3xl font-bold">--</div></div>
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500">MODEINFO</div><div id="modeinfo" class="text-3xl font-bold">--</div></div>
      <!--	ä¸­ï¼šç­‰å¾…è„šæœ¬å¡«å…¥å®žæ—¶æ•°å€¼ã€‚
      EN: Placeholders pending JS fill.
      FR: Espaces rÃ©servÃ©s remplis par JS-->
      </div>

      <div class="bg-white p-5 card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Prediction</h3>
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-500">Updated: <span id="updatedAt">--</span></span>
            <button id="refreshBtn" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Refresh</button>
          </div>
        </div>
        <div id="predictBox" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div><div class="text-gray-500">Next shower</div><div id="pred_shower" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Expected temp</div><div id="pred_temp" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Solar enough?</div><div id="pred_ok" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Extra kWh</div><div id="pred_kwh" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Est. cost</div><div id="pred_cost" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Suggested schedule</div><div id="pred_sched" class="font-medium">--</div></div>
        </div>
      </div>
    </section>

    <!-- History -->
    <section id="page-history" class="hidden space-y-4">
      <div class="bg-white p-5 card">
        <div class="flex items-center gap-2 text-sm">
          <select id="histMetric" class="border rounded-lg px-2 py-1">
            <option value="SAVED_Cost">SAVED_Cost</option>
            <option value="TOTAL_PROD">TOTAL_PROD</option>
            <option value="INJECT">INJECT</option>
          </select>
          <select id="histRange" class="border rounded-lg px-2 py-1">
            <option value="7d">7d</option><option value="30d">30d</option>
          </select>
          <button id="histLoad" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Load</button>
          <a id="csvLink" class="ml-auto underline" href="/api/history/export.csv?range=30d">Export CSV</a>
        </div>
        <div class="mt-4">
          <pre id="histData" class="text-xs text-gray-700 whitespace-pre-wrap"></pre>
        </div>
      </div>
    </section>

    <!-- Boost -->
    <section id="page-boost" class="hidden">
      <div class="bg-white p-5 card space-y-4 max-w-xl">
        <div class="text-sm">Status: <span id="boostStatus" class="font-medium">--</span></div>
        <div class="flex gap-2">
          <button id="boostOn" class="px-3 py-1.5 rounded-lg bg-green-600 text-white hover:opacity-90">Boost ON</button>
          <button id="boostOff" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="page-settings" class="hidden">
      <div class="bg-white p-5 card space-y-3 max-w-xl">
        <h3 class="font-semibold">User Settings</h3>
        <label class="block text-sm">Typical shower time
          <input id="s_typical" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="07:30">
        </label>
        <label class="block text-sm">Next shower (override once)
          <input id="s_next" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="07:30">
        </label>
        <label class="block text-sm">Desired temp (next)
          <input id="s_temp" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="50">
        </label>
        <label class="block text-sm">Guests expected
          <input id="s_guests" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" value="0">
        </label>
        <label class="block text-sm">Page refresh interval (s)
          <input id="s_refresh" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" value="5">
        </label>
        <div class="flex gap-2">
          <button id="s_save" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Save</button>
          <span id="s_msg" class="text-sm text-green-700"></span>
        </div>
      </div>
    </section>

    <!-- MQTT -->
    <section id="page-mqtt" class="hidden">
      <div class="bg-white p-5 card space-y-2 max-w-xl text-sm">
        <div>Broker: <span id="mq_host" class="font-medium">-</span></div>
        <div>Port: <span id="mq_port" class="font-medium">-</span></div>
        <div>Connected: <span id="mq_conn" class="font-medium">-</span></div>
        <div>Last sync: <span id="mq_sync" class="font-medium">-</span></div>
        <div>Publish Hz: <span id="mq_hz" class="font-medium">-</span></div>
        <div>Sub topic: <span id="mq_topic" class="font-medium">-</span></div>
      </div>
    </section>

    <!-- Dev -->
    <section id="page-dev" class="hidden">
      <div class="bg-white p-5 card space-y-3">
        <h3 class="font-semibold">Developer</h3>
        <div class="text-sm text-gray-600">List routers (dev only):</div>
        <button id="devList" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Load Routers</button>
        <pre id="devOut" class="text-xs mt-2 whitespace-pre-wrap"></pre>
      </div>
    </section>

    <!-- Client -->
    <section id="page-client" class="hidden space-y-4">
      <!-- ä½ç½®æ¨¡å— -->
      <div class="bg-white p-5 card space-y-3 max-w-2xl">
        <h3 class="font-semibold">Client â€“ Position</h3>

        <!-- åŸŽå¸‚ä¸‹æ‹‰ï¼šé‡Œå°” / åŠ æ¥ / æ•¦åˆ»å°”å…‹ -->
        <label class="block text-sm">City (optional)
          <select id="c_city" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="">-- Manual / Other --</option>
            <option value="lille">Lille</option>
            <option value="calais">Calais</option>
            <option value="dunkerque">Dunkerque</option>
          </select>
        </label>

        <!-- ç»åº¦ / çº¬åº¦ / æµ·æ‹” -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="block text-sm">Latitude
            <input id="c_lat" type="number" step="0.000001"
                   class="mt-1 w-full border rounded-lg px-3 py-2"
                   placeholder="e.g. 50.62925">
          </label>
          <label class="block text-sm">Longitude
            <input id="c_lon" type="number" step="0.000001"
                   class="mt-1 w-full border rounded-lg px-3 py-2"
                   placeholder="e.g. 3.057256">
          </label>
          <label class="block text-sm">Altitude (m)
            <input id="c_alt" type="number" step="1"
                   class="mt-1 w-full border rounded-lg px-3 py-2"
                   placeholder="e.g. 25">
          </label>
        </div>

        <!-- GPS / IP å®šä½ï¼ˆç›®å‰åªåšå‰ç«¯æç¤ºï¼Œå ä½ï¼‰ -->
        <div class="flex items-center gap-2 text-sm">
          <button id="c_gps_btn"
                  class="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300">
            Use GPS / IP (demo)
          </button>
          <span id="c_gps_msg" class="text-gray-500 text-xs">
            (front-end placeholder for now)
          </span>
        </div>
      </div>

      <!-- å…‰ä¼å‚æ•°æ¨¡å— -->
      <div class="bg-white p-5 card space-y-3 max-w-2xl">
        <h3 class="font-semibold">Client â€“ PV parameters</h3>

        <!-- ä¸¤ç§æ¨¡å¼ï¼šçŸ¥é“æ‰€æœ‰æŠ€æœ¯ç»†èŠ‚ / åªçŸ¥é“ç®€åŒ–å‚æ•° -->
        <div class="flex flex-col md:flex-row gap-4 text-sm">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="pv_mode" value="full" checked>
            <span>I know all technical details</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="pv_mode" value="simple">
            <span>I don't know all details (simple mode)</span>
          </label>
        </div>

        <!-- æ¨¡å¼ 1ï¼šå…¨éƒ¨æŠ€æœ¯ç»†èŠ‚ -->
        <div id="pv_full_box" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <label class="block">Azimuth du panneau
            <input id="pv_azimuth_full" type="number"
                   class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="180">
          </label>
          <label class="block">Inclinaison / Tilt (Â°)
            <input id="pv_tilt_full" type="number"
                   class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="25">
          </label>
          <label class="block">Surface du panneau (mÂ²)
            <input id="pv_surface_full" type="number" step="0.1"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
          <label class="block">Puissance nominale du panneau (Wc)
            <input id="pv_pnom" type="number"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
          <label class="block">Plafond de puissance de lâ€™onduleur (W)
            <input id="pv_inverter_ceiling" type="number"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
          <label class="block">EfficacitÃ© nominale de lâ€™onduleur
            <input id="pv_inverter_eff" type="number" step="0.01"
                   class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="0.97">
          </label>
          <label class="block">Pertes dans les cÃ¢bles (%)
            <input id="pv_cable_losses" type="number" step="0.1"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
        </div>

        <!-- æ¨¡å¼ 2ï¼šç®€åŒ–å‚æ•° + æ•´ä½“æ•ˆçŽ‡ -->
        <div id="pv_simple_box" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm hidden">
          <label class="block">Azimuth du panneau
            <input id="pv_azimuth_simple" type="number"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
          <label class="block">Inclinaison / Tilt (Â°)
            <input id="pv_tilt_simple" type="number"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
          <label class="block">Surface du panneau (mÂ²)
            <input id="pv_surface_simple" type="number" step="0.1"
                   class="mt-1 w-full border rounded-lg px-3 py-2">
          </label>
          <label class="block">Rendement global de lâ€™installation
            <input id="pv_global_eff" type="number" step="0.01"
                   class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="0.8">
          </label>
          <label class="inline-flex items-center gap-2 mt-2">
            <input id="pv_auto_adjust" type="checkbox" checked>
            <span>Use auto_adjusting_params (recommended)</span>
          </label>
        </div>

        <!-- ä¿å­˜æŒ‰é’® -->
        <div class="flex items-center gap-3 mt-2">
          <button id="c_save"
                  class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">
            Save client
          </button>
          <span id="c_msg" class="text-sm text-green-700"></span>
        </div>
      </div>
    </section>

  </main>

  <script>
    // ======== Session & API helper =========
    function getSession(){ try{ return JSON.parse(localStorage.getItem('session')||'{}'); }catch{ return {}; } }
    function setSession(s){ localStorage.setItem('session', JSON.stringify(s)); }
    async function apicall(path, opts={}){
      const s = getSession();
      opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
      if (s.token) opts.headers['Authorization'] = 'Bearer ' + s.token;
      const r = await fetch(path, opts);
      if (r.status === 401) { localStorage.removeItem('session'); location.hash = '#/login'; throw new Error('Unauthorized'); }
      if (!r.ok) throw new Error(await r.text());
      const ct = r.headers.get('content-type')||'';
      return ct.includes('application/json') ? r.json() : r.text();
    }

    // ======== Router (very simple) =========
    const pages = ['login','dashboard','history','boost','settings','mqtt','dev','client'];
    function show(page){
      pages.forEach(p=>document.getElementById('page-'+p).classList.add('hidden'));
      document.getElementById('page-'+page).classList.remove('hidden');
      document.getElementById('statusText').textContent = page;
    }
    function guard(){
      const s = getSession();
      const hash = location.hash || '#/login';
      const path = hash.replace('#/','');
      if (!s.token && path !== 'login'){ location.hash = '#/login'; return; }
      if (s.token && path === 'login'){ location.hash = '#/dashboard'; return; }
      show(path);
    }
    window.addEventListener('hashchange', guard);

    // ======== Login =========
    document.getElementById('loginBtn').onclick = async ()=>{
      const router_id = document.getElementById('fRouter').value.trim();
      const password  = document.getElementById('fPass').value;
      const lang      = document.getElementById('fLang').value;
      try{
        const resp = await apicall('/api/auth/login',{method:'POST',body:JSON.stringify({router_id,password,lang})});
        setSession(resp);
        location.hash = '#/dashboard';
      }catch(e){ document.getElementById('loginErr').textContent = e.message || 'Login failed'; }
    };
    document.getElementById('logoutBtn').onclick = ()=>{
      localStorage.removeItem('session'); location.hash = '#/login';
    };

    // ======== Dashboard =========
    async function loadStatus(){
      const j = await apicall('/api/status');
      q('#grid_w').textContent = n(j.grid_w);
      q('#solar_w').textContent = n(j.solar_w);
      q('#temp_c').textContent = n(j.temp_c);
      q('#modeinfo').textContent = j.modeinfo ?? '--';
      q('#updatedAt').textContent = new Date((j.updated_at||Date.now())*1000).toLocaleString();
      const p = j.predict || {};
      q('#pred_shower').textContent = p.next_shower ?? '--';
      q('#pred_temp').textContent = n(p.expected_temp);
      q('#pred_ok').textContent = p.solar_enough ? 'YES' : 'NO';
      q('#pred_kwh').textContent = n(p.extra_kwh_needed);
      q('#pred_cost').textContent = n(p.estimated_cost);
      q('#pred_sched').textContent = (p.suggested_schedule||[]).join(', ');
    }
    q('#refreshBtn').onclick = loadStatus;

    // ======== History =========
    q('#histLoad').onclick = async ()=>{
      const m = q('#histMetric').value, r = q('#histRange').value;
      const j = await apicall(`/api/history?metric=${encodeURIComponent(m)}&range=${encodeURIComponent(r)}`);
      q('#histData').textContent = JSON.stringify(j.series, null, 2);
      q('#csvLink').href = `/api/history/export.csv?range=${encodeURIComponent(r)}`;
    };

    // ======== Boost =========
    async function refreshBoost(){
      const j = await apicall('/api/boost'); q('#boostStatus').textContent = j.active ? 'ACTIVE' : 'INACTIVE';
    }
    q('#boostOn').onclick  = async()=>{ await apicall('/api/boost',{method:'POST',body:JSON.stringify({on:true})});  refreshBoost(); };
    q('#boostOff').onclick = async()=>{ await apicall('/api/boost',{method:'DELETE'}); refreshBoost(); };

    // ======== Settings =========
    async function loadSettings(){
      const s = await apicall('/api/settings');
      q('#s_typical').value = s.typical_shower_time || '';
      q('#s_next').value    = s.next_shower_time || '';
      q('#s_temp').value    = s.desired_temp_next ?? 50;
      q('#s_guests').value  = s.guests_expected ?? 0;
      q('#s_refresh').value = s.page_refresh_interval ?? 5;
    }
    q('#s_save').onclick = async ()=>{
      const b = {
        typical_shower_time: q('#s_typical').value.trim(),
        next_shower_time: q('#s_next').value.trim(),
        desired_temp_next: parseFloat(q('#s_temp').value),
        guests_expected: parseInt(q('#s_guests').value||'0'),
        page_refresh_interval: parseInt(q('#s_refresh').value||'5'),
      };
      await apicall('/api/settings',{method:'POST',body:JSON.stringify(b)});
      q('#s_msg').textContent = 'Saved!';
      setTimeout(()=>q('#s_msg').textContent='', 1500);
    };

    // ======== MQTT =========
    async function loadMQTT(){
      const j = await apicall('/api/mqtt/status');
      q('#mq_host').textContent = j.broker; q('#mq_port').textContent = j.port;
      q('#mq_conn').textContent = j.connected ? 'Yes' : 'No';
      q('#mq_sync').textContent = j.last_sync || '-';
      q('#mq_hz').textContent   = j.publish_hz || '-';
      q('#mq_topic').textContent= j.sub_topic || '-';
    }

    // ======== Dev =========
    q('#devList').onclick = async ()=>{
      try{ const j = await apicall('/api/dev/routers'); q('#devOut').textContent = JSON.stringify(j, null, 2); }
      catch(e){ q('#devOut').textContent = e.message; }
    };

    // ======== Utilities =========
    function q(s){ return document.querySelector(s); }
    function n(v){ return (v===0||v) ? String(v) : '--'; }
    // ======== Client page (position + PV params) =========

    // é¢„è®¾åŸŽå¸‚åæ ‡ï¼ˆç®€å•ç¤ºä¾‹å€¼ï¼‰
    const CITY_PRESETS = {
      lille:     {lat: 50.62925, lon: 3.057256, alt: 25},
      calais:    {lat: 50.95129, lon: 1.85869,  alt: 5},
      dunkerque:{lat: 51.03437, lon: 2.37682,  alt: 4},
    };

    // åŸŽå¸‚ä¸‹æ‹‰æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨å¡«å…¥ç»çº¬åº¦æµ·æ‹”
    const citySel = document.getElementById('c_city');
    if (citySel){
      citySel.onchange = ()=>{
        const v = citySel.value;
        const p = CITY_PRESETS[v];
        if (p){
          q('#c_lat').value = p.lat;
          q('#c_lon').value = p.lon;
          q('#c_alt').value = p.alt;
        }
      };
    }

    // GPS/IP æŒ‰é’®ï¼šç›®å‰åªåšå‰ç«¯å ä½
    const gpsBtn = document.getElementById('c_gps_btn');
    if (gpsBtn){
      gpsBtn.onclick = ()=>{
        q('#c_gps_msg').textContent = 'GPS / IP auto-detect not implemented yet (front-end demo).';
      };
    }

    // åˆ‡æ¢ full / simple æ¨¡å¼
    function updatePVModeUI(){
      const mode = document.querySelector('input[name="pv_mode"]:checked')?.value || 'full';
      const fullBox   = document.getElementById('pv_full_box');
      const simpleBox = document.getElementById('pv_simple_box');
      if (mode === 'full'){
        fullBox.classList.remove('hidden');
        simpleBox.classList.add('hidden');
      }else{
        fullBox.classList.add('hidden');
        simpleBox.classList.remove('hidden');
      }
    }
    document.querySelectorAll('input[name="pv_mode"]').forEach(r=>{
      r.addEventListener('change', updatePVModeUI);
    });

    // è¯»å–åŽç«¯å·²æœ‰ client é…ç½®
    async function loadClient(){
      try{
        const j = await apicall('/api/client');
        if (!j || !j.position) return; // è¿˜æ²¡æœ‰ä¿å­˜è¿‡ï¼Œä¿æŒé»˜è®¤ç©ºå€¼

        // ä½ç½®
        q('#c_lat').value = j.position.latitude ?? '';
        q('#c_lon').value = j.position.longitude ?? '';
        q('#c_alt').value = j.position.altitude ?? '';

        // PV
        const pv = j.pv_config || {};
        if (pv.detail_level === 'simple'){
          document.querySelector('input[name="pv_mode"][value="simple"]').checked = true;
        }else{
          document.querySelector('input[name="pv_mode"][value="full"]').checked = true;
        }
        updatePVModeUI();

        if (pv.detail_level === 'full'){
          q('#pv_azimuth_full').value = pv.azimuth ?? '';
          q('#pv_tilt_full').value    = pv.tilt ?? '';
          q('#pv_surface_full').value = pv.surface ?? '';
          q('#pv_pnom').value         = pv.power_nominal ?? '';
          q('#pv_inverter_ceiling').value   = pv.inverter_ceiling ?? '';
          q('#pv_inverter_eff').value       = pv.inverter_efficiency ?? '';
          q('#pv_cable_losses').value       = pv.cable_losses ?? '';
        }else{
          q('#pv_azimuth_simple').value = pv.azimuth ?? '';
          q('#pv_tilt_simple').value    = pv.tilt ?? '';
          q('#pv_surface_simple').value = pv.surface ?? '';
          q('#pv_global_eff').value     = pv.global_efficiency ?? '';
          q('#pv_auto_adjust').checked  = !!pv.auto_adjusting_params;
        }
      }catch(e){
        console.error('loadClient failed', e);
      }
    }

    // ä¿å­˜ client é…ç½®åˆ°åŽç«¯
    const saveBtn = document.getElementById('c_save');
    if (saveBtn){
      saveBtn.onclick = async ()=>{
        try{
          const mode = document.querySelector('input[name="pv_mode"]:checked')?.value || 'full';
          const position = {
            latitude:  parseFloat(q('#c_lat').value),
            longitude: parseFloat(q('#c_lon').value),
            altitude:  parseFloat(q('#c_alt').value),
          };

          let pv_config;
          if (mode === 'full'){
            pv_config = {
              detail_level: 'full',
              azimuth:  parseFloat(q('#pv_azimuth_full').value),
              tilt:     parseFloat(q('#pv_tilt_full').value),
              surface:  parseFloat(q('#pv_surface_full').value),
              power_nominal:       parseFloat(q('#pv_pnom').value),
              inverter_ceiling:    parseFloat(q('#pv_inverter_ceiling').value),
              inverter_efficiency: parseFloat(q('#pv_inverter_eff').value),
              cable_losses:        parseFloat(q('#pv_cable_losses').value),
              global_efficiency: null,
              auto_adjusting_params: null
            };
          }else{
            pv_config = {
              detail_level: 'simple',
              azimuth:  parseFloat(q('#pv_azimuth_simple').value),
              tilt:     parseFloat(q('#pv_tilt_simple').value),
              surface:  parseFloat(q('#pv_surface_simple').value),
              power_nominal: null,
              inverter_ceiling: null,
              inverter_efficiency: null,
              cable_losses: null,
              global_efficiency: parseFloat(q('#pv_global_eff').value),
              auto_adjusting_params: !!q('#pv_auto_adjust').checked
            };
          }

          await apicall('/api/client', {
            method:'POST',
            body: JSON.stringify({position, pv_config})
          });
          q('#c_msg').textContent = 'Saved!';
          setTimeout(()=>q('#c_msg').textContent='', 1500);
        }catch(e){
          q('#c_msg').textContent = 'Error: ' + (e.message || 'save failed');
        }
      };
    }

    // åˆå§‹è·¯ç”±
    guard();
    // é¦–æ¬¡è¿›å…¥å„é¡µæ—¶åšè½»é‡åŠ è½½
    window.addEventListener('hashchange', ()=>{
      const page = location.hash.replace('#/','');
      if (page==='dashboard') loadStatus();
      if (page==='history')   q('#histLoad').click();
      if (page==='boost')     refreshBoost();
      if (page==='settings')  loadSettings();
      if (page==='mqtt')      loadMQTT();
      if (page==='client')    loadClient();
    });
  </script>
</body>
</html>